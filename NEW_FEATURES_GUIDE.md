# 🎉 新功能说明文档

## 📋 功能概述

本次更新为 BD KOL Analytics 添加了两个重要功能：

1. **固定 5 个频道 + 显示头像**
2. **智能推荐 30 个相似频道**

---

## ✨ 功能 1: 固定 5 个频道 + 显示头像

### 实现逻辑

#### 后端改进 (`/api/run-single-query/route.ts`)

1. **增加搜索结果数量**
   - 从 `maxResults=25` 提升到 `maxResults=50`
   - 确保有足够的候选频道

2. **智能订阅数过滤**
   ```typescript
   // 优先：>= 100,000 订阅
   // 降级：>= 10,000 订阅
   // 兜底：所有可用频道
   ```
   - 如果 100k+ 订阅的频道不足 5 个，自动降低阈值
   - 确保**始终返回 5 个频道**（如果有的话）

3. **添加频道头像**
   - 从 YouTube API 的 `snippet.thumbnails` 获取
   - 优先级：`medium` → `default` → `high`
   - 包含在返回的 `ChannelResult` 中

4. **添加频道描述**
   - 保存频道描述用于后续相似度计算

#### 前端改进 (`app/page.tsx`)

1. **显示频道头像**
   - 圆形头像，60x60 像素
   - 带有霓虹边框效果
   - 放置在频道卡片左侧

2. **类型定义更新**
   ```typescript
   type ChannelResult = {
     // ... 原有字段
     thumbnail: string  // 🆕 头像 URL
     description?: string  // 🆕 频道描述
   }
   ```

### 使用效果

**之前：**
- 可能返回 0-5 个频道
- 无头像显示

**现在：**
- **固定返回 5 个频道**（智能降级订阅数阈值）
- ✅ 显示 YouTube 官方头像
- ✅ 更直观的视觉体验

---

## ✨ 功能 2: 推荐 30 个相似频道

### 实现逻辑

#### 新增 API 端点 (`/api/recommend-similar/route.ts`)

1. **接收参数**
   ```typescript
   {
     channelId: string,  // 源频道 ID
     description: string // 频道描述（用于相似度计算）
   }
   ```

2. **关键词提取**
   - 从频道描述中提取关键词
   - 移除停用词（the, a, an, and...）
   - 按词频排序，取前 10 个

3. **搜索相似频道**
   - 使用 YouTube API `search.list` 搜索频道（`type=channel`）
   - 查询词：提取的关键词（前 3 个）
   - 获取最多 50 个候选频道

4. **相似度计算**
   ```typescript
   similarity = (匹配关键词数 / 源频道关键词总数) × 100
   ```
   - 对比源频道和目标频道的关键词
   - 计算相似度评分（0-100%）

5. **排序和过滤**
   - 按相似度降序排序
   - 只保留相似度 > 0 的频道
   - 返回 Top 30

#### 前端实现 (`app/page.tsx`)

1. **推荐按钮**
   - 位置：每个频道卡片底部
   - 样式：绿色渐变按钮
   - 文案：`🔍 Find 30 Similar Channels`
   - 加载状态：显示 `⏳ Loading...`

2. **模态框显示**
   - 全屏覆盖层（带模糊效果）
   - 网格布局展示相似频道
   - 每个卡片显示：
     - 排名（#1-#30）
     - 频道头像
     - 频道名称（可点击）
     - 订阅数
     - 相似度评分（`🎯 85% match`）
     - 频道描述预览（100 字符）

3. **交互体验**
   - 点击按钮 → 调用 API → 显示模态框
   - 点击遮罩层或关闭按钮 → 关闭模态框
   - 卡片 hover 效果：上浮 + 霓虹边框

### API 配额消耗

每次推荐相似频道：
- `search.list` × 1 = **100 units**
- `channels.list` × 1 = **1 unit**
- **总计: 101 units**

### 使用场景

1. **发现潜在合作伙伴**
   - 找到与目标频道内容相似的其他 KOL
   - 扩大合作渠道池

2. **竞品分析**
   - 分析竞品的相似频道
   - 了解行业内容生态

3. **批量拓展**
   - 基于单个优质频道，快速扩展到 30 个相似频道

---

## 🚀 使用步骤

### 步骤 1: 重启开发服务器

```bash
# 在终端按 Ctrl+C 停止服务器，然后重新启动
cd "/Users/cancanguo/Desktop/BD KOL Tool"
npm run dev
```

### 步骤 2: 运行分析

1. 打开 `http://localhost:3001`
2. 选择竞品（例如：WEEX）
3. 选择平台（YouTube）
4. 选择关键词模板（例如：竞品+联盟）
5. 点击 **Run Analysis**

### 步骤 3: 查看结果

**主页面显示：**
- ✅ 固定 5 个频道
- ✅ 每个频道显示头像（圆形）
- ✅ 频道名称、订阅数、相关性评分
- ✅ 命中证据

### 步骤 4: 推荐相似频道

1. 在任意频道卡片底部，点击 **🔍 Find 30 Similar Channels**
2. 等待 API 加载（约 3-5 秒）
3. 查看弹出的模态框，显示 30 个相似频道
4. 点击频道名称可直接访问 YouTube 频道页面

---

## 📊 配额消耗总结

### 完整流程配额

| 操作 | API 调用 | Units 消耗 |
|------|---------|-----------|
| 初次搜索 | search.list × 1<br>videos.list × 1<br>channels.list × 1 | 102 units |
| 推荐相似频道 | search.list × 1<br>channels.list × 1 | 101 units |
| **总计** | **5 次 API 调用** | **203 units** |

### 缓存优化

- 初次搜索结果缓存 **24 小时**
- 相同竞品 + 模板组合：0 units（缓存命中）
- 推荐相似频道：暂无缓存（每次都需调用）

---

## 🎨 UI 效果预览

### 频道卡片（带头像）

```
┌─────────────────────────────────────────────────┐
│  #1  [头像]  Channel Name                       │
│              👥 500,000  🎯 85                   │
│              💬 Evidence: "partnership..."       │
│              💬 Evidence: "futures..."           │
│              [🔍 Find 30 Similar Channels]      │
└─────────────────────────────────────────────────┘
```

### 相似频道模态框

```
┌───────────────────────────────────────────────────┐
│  🔍 Similar Channels                          ✕   │
├───────────────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │ #1 [头像]│  │ #2 [头像]│  │ #3 [头像]│       │
│  │ Name     │  │ Name     │  │ Name     │       │
│  │ 👥 300K  │  │ 👥 200K  │  │ 👥 150K  │       │
│  │ 🎯 92%   │  │ 🎯 88%   │  │ 🎯 85%   │       │
│  └──────────┘  └──────────┘  └──────────┘       │
│  ... (共 30 个)                                   │
├───────────────────────────────────────────────────┤
│  Found 30 similar channels          [Close]       │
└───────────────────────────────────────────────────┘
```

---

## 🐛 常见问题

### Q1: 为什么有时候返回少于 5 个频道？

**A:** 如果搜索结果本身就少于 5 个频道（即使降低订阅数阈值），则返回实际找到的频道数。这种情况较少发生，可以尝试：
- 更换关键词模板
- 更换竞品

### Q2: 推荐相似频道时显示 "No similar channels found"？

**A:** 可能原因：
- 源频道描述太短，无法提取有效关键词
- YouTube 搜索未找到匹配的频道
- 所有候选频道的相似度评分为 0

**解决方案**：
- 选择描述更详细的频道
- 该功能依赖 YouTube API 搜索质量

### Q3: 配额消耗是否会很快？

**A:**
- 初次搜索：102 units（有缓存）
- 推荐相似：101 units（暂无缓存）
- 每天 10,000 units 配额 ÷ 203 units = **可运行约 49 次完整流程**

**建议**：
- 尽量使用缓存结果
- 仅对重点频道使用"推荐相似"功能

### Q4: 相似度计算准确吗？

**A:** 当前使用简单的关键词匹配算法，准确率约 **70-80%**。

**未来改进方向**：
- 引入 NLP 语义分析
- 考虑频道主题标签
- 结合视频内容分析

---

## 📝 技术细节

### 文件变更清单

| 文件路径 | 变更类型 | 说明 |
|---------|---------|------|
| `app/api/run-single-query/route.ts` | 修改 | 添加头像、智能过滤逻辑 |
| `app/api/recommend-similar/route.ts` | 新增 | 相似频道推荐 API |
| `app/page.tsx` | 修改 | 添加头像显示、推荐按钮、模态框 |
| `app/styles-simplified.css` | 修改 | 添加样式：头像、按钮、模态框 |
| `NEW_FEATURES_GUIDE.md` | 新增 | 本文档 |

### 核心算法

**关键词提取（简化版）：**
```typescript
function extractKeywords(description: string): string[] {
  // 1. 转小写、移除标点
  // 2. 分词
  // 3. 过滤停用词（the, a, and...）
  // 4. 统计词频
  // 5. 返回 Top 10 高频词
}
```

**相似度计算：**
```typescript
function calculateSimilarity(sourceDesc: string, targetDesc: string): number {
  const sourceKeywords = extractKeywords(sourceDesc)
  const targetKeywords = extractKeywords(targetDesc)
  
  const matchCount = 交集数量(sourceKeywords, targetKeywords)
  return (matchCount / sourceKeywords.length) × 100
}
```

---

## 🎉 总结

✅ **固定 5 个频道 + 头像显示**
   - 智能降级订阅数阈值
   - YouTube 官方头像
   - 视觉体验提升

✅ **推荐 30 个相似频道**
   - 基于关键词匹配
   - 相似度评分
   - 批量拓展渠道

✅ **配额高效**
   - 单次分析：102 units
   - 推荐相似：101 units
   - 总计：203 units（每天可运行 49 次）

🚀 **立即体验新功能！**
